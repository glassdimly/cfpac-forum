"use strict";define("composer",["taskbar","translator","composer/controls","composer/uploads","composer/formatting","composer/drafts","composer/tags","composer/categoryList","composer/preview","composer/resize","composer/autocomplete","scrollStop"],function(e,t,i,o,n,a,r,s,d,l,c,p){var f={active:undefined,posts:{},bsEnvironment:undefined,formatting:undefined};$(window).off("resize",m).on("resize",m);m();$(window).on("action:composer.topics.post",function(e,t){localStorage.removeItem("category:"+t.data.cid+":bookmark");localStorage.removeItem("category:"+t.data.cid+":bookmark:clicked")});$(window).on("popstate",function(){var e=utils.findBootstrapEnvironment();if(f.active&&(e==="xs"||e==="sm")){if(!f.posts[f.active].modified){f.discard(f.active);if(f.discardConfirm&&f.discardConfirm.length){f.discardConfirm.modal("hide");delete f.discardConfirm}return}t.translate("[[modules:composer.discard]]",function(e){f.discardConfirm=bootbox.confirm(e,function(e){if(e){f.discard(f.active)}else{f.posts[f.active].modified=true}});f.posts[f.active].modified=false})}});function u(){var e=f.bsEnvironment;if(ajaxify.data.template.compose===true||e==="xs"||e==="sm"){history.back()}}function m(){var e=utils.findBootstrapEnvironment();var t=e==="xs"||e==="sm";if(d.toggle){if(d.env!==e&&t){d.env=e;d.toggle(false)}d.env=e}if(f.active!==undefined){l.reposition($('.composer[data-uuid="'+f.active+'"]'));if(!t&&window.location.pathname.startsWith(config.relative_path+"/compose")){history.back()}else if(t&&!window.location.pathname.startsWith(config.relative_path+"/compose")){w()}}f.bsEnvironment=e}function g(e){var t,i;if(e.hasOwnProperty("cid")){t="cid"}else if(e.hasOwnProperty("tid")){t="tid"}else if(e.hasOwnProperty("pid")){t="pid"}i=e[t];for(var o in f.posts){if(f.posts[o].hasOwnProperty(t)&&i===f.posts[o][t]){return o}}return false}function v(i){var o=utils.generateUUID(),n=g(i);if(n){e.updateActive(n);return f.load(n)}var r="[[topic:composer.new_topic]]";if(i.action==="posts.reply"){r="[[topic:composer.replying_to]]"}else if(i.action==="posts.edit"){r="[[topic:composer.editing]]"}t.translate(r,function(t){e.push("composer",o,{title:t.replace("%1",'"'+i.title+'"')})});if(0!==parseInt(app.user.uid,10)){if(i.hasOwnProperty("cid")){i.save_id=["composer",app.user.uid,"cid",i.cid].join(":")}else if(i.hasOwnProperty("tid")){i.save_id=["composer",app.user.uid,"tid",i.tid].join(":")}else if(i.hasOwnProperty("pid")){i.save_id=["composer",app.user.uid,"pid",i.pid].join(":")}}a.updateVisibility("available",i.save_id,true);a.updateVisibility("open",i.save_id,true);f.posts[o]=i;f.load(o)}function h(e,t){$('.composer[data-uuid="'+e+'"]').find(".composer-submit").removeAttr("disabled");app.alert({type:"danger",timeout:3e3,title:"",message:t,alert_id:"post_error"})}f.findByTid=function(e){for(var t in f.posts){if(f.posts.hasOwnProperty(t)&&f.posts[t].hasOwnProperty("tid")&&parseInt(f.posts[t].tid,10)===parseInt(e,10)){return t}}return null};f.addButton=function(e,t,i){n.addButton(e,t,i)};f.newTopic=function(e){var t={action:"topics.post",cid:e.cid,title:e.title||"",body:e.body||"",tags:e.tags||[],modified:e.title.length||e.body.length?true:false,isMain:true};$(window).trigger("filter:composer.topic.push",{data:e,pushData:t});v(t)};f.addQuote=function(e,i,o,n,a,r,s){s=s||f.active;var l=(n||"").replace(/([\\`*_{}\[\]()#+\-.!])/g,"\\$1").replace(/\[/g,"&#91;").replace(/\]/g,"&#93;").replace(/%/g,"&#37;").replace(/,/g,"&#44;");if(r){r="> "+r.replace(/\n/g,"\n> ")+"\n\n"}var c="["+l+"]("+config.relative_path+"/post/"+(o||i)+")";if(s===undefined){if(n&&(o||i)){f.newReply(e,i,n,"[[modules:composer.user_said_in, "+a+", "+c+"]]\n"+r)}else{f.newReply(e,i,n,"[[modules:composer.user_said, "+a+"]]\n"+r)}return}else if(s!==f.active){f.load(s)}var p=$('.composer[data-uuid="'+s+'"]');var u=p.find("textarea");var m=u.val();if(n&&(o||i)){t.translate("[[modules:composer.user_said_in, "+a+", "+c+"]]\n",config.defaultLang,g)}else{t.translate("[[modules:composer.user_said, "+a+"]]\n",config.defaultLang,g)}function g(e){f.posts[s].body=(m.length?m+"\n\n":"")+e+r;u.val(f.posts[s].body);_(p);d.render(p)}};f.newReply=function(e,i,o,n){t.translate(n,config.defaultLang,function(t){v({action:"posts.reply",tid:e,toPid:i,title:o,body:t,modified:o.length||body.length?true:false,isMain:false})})};f.editPost=function(e){socket.emit("plugins.composer.push",e,function(t,i){if(t){return app.alertError(t.message)}i.action="posts.edit";i.pid=e;i.modified=false;v(i)})};f.load=function(e){var t=$('.composer[data-uuid="'+e+'"]');if(t.length){T(e);l.reposition(t);_(t);E()}else{if(f.formatting){b(e)}else{socket.emit("plugins.composer.getFormattingOptions",function(t,i){f.formatting=i;b(e)})}}};f.enhance=function(e,i,l){if(!i&&!l){i=utils.generateUUID();f.posts[i]=l=ajaxify.data;e.attr("data-uuid",i)}var p=e.find("input.title");var m=e.find("textarea");var g=a.get(l.save_id);var v=e.find(".composer-submit");s.init(e,f.posts[i]);n.addHandler(e);n.addComposerButtons();d.handleToggler(e);e.find(".img-upload-btn").removeClass("hide");e.find("#files.lt-ie9").removeClass("hide");if(config.allowFileUploads){e.find(".file-upload-btn").removeClass("hide");e.find("#files.lt-ie9").removeClass("hide")}o.initialize(i);if(config.allowTopicsThumbnail&&l.isMain){o.toggleThumbEls(e,f.posts[i].thumb||"")}r.init(e,f.posts[i]);c.init(e,i);e.on("change","input, textarea",function(){f.posts[i].modified=true});v.on("click",function(e){e.preventDefault();e.stopPropagation();$(this).attr("disabled",true);P(i)});e.keypress(function(e){var t=e.which?e.which:e.keyCode;if((t===10||t==13)&&e.ctrlKey){v.attr("disabled",true);P(i);return false}return true});e.find(".composer-discard").on("click",function(e){e.preventDefault();if(!f.posts[i].modified){f.discard(i);return u()}var o=$(this).prop("disabled",true);t.translate("[[modules:composer.discard]]",function(e){bootbox.confirm(e,function(e){if(e){f.discard(i);u()}o.prop("disabled",false)})})});e.find(".composer-minimize").on("click",function(e){e.preventDefault();e.stopPropagation();f.minimize(i)});m.on("input propertychange",function(){d.render(e)});m.on("scroll",function(){d.matchScroll(e)});d.render(e,function(){d.matchScroll(e)});if(g&&g.title){p.val(g.title)}m.val(g.text?g.text:l.body);if(app.user.uid>0){a.init(e,l)}y(e);x(e);_(e);if(typeof screenfull!=="undefined"&&!screenfull.enabled){$('[data-format="zen"]').addClass("hidden")}$(window).trigger("action:composer.enhanced",{postContainer:e})};function b(i){var o=f.posts[i];var n=config.allowTopicsThumbnail&&o.isMain,a=o?o.hasOwnProperty("cid"):false,r=o?!!o.isMain:false,s=o?!!o.pid:false,d=o?parseInt(o.uid,10)===0:false;var c=o.title.replace(/%/g,"&#37;").replace(/,/g,"&#44;");var u={title:c,mobile:f.bsEnvironment==="xs"||f.bsEnvironment==="sm",resizable:true,allowTopicsThumbnail:n,isTopicOrMain:a||r,minimumTagLength:config.minimumTagLength,maximumTagLength:config.maximumTagLength,isTopic:a,isEditing:s,showHandleInput:config.allowGuestHandles&&(app.user.uid===0||s&&d&&app.user.isAdmin),handle:o?o.handle||"":undefined,formatting:f.formatting,tagWhitelist:ajaxify.data.tagWhitelist,privileges:app.user.privileges};if(u.mobile){w();app.toggleNavbar(false)}o.mobile=f.bsEnvironment==="xs"||f.bsEnvironment==="sm";$(window).trigger("filter:composer.create",{postData:o,createData:u});app.parseAndTranslate("composer",u,function(n){if($('.composer.composer[data-uuid="'+i+'"]').length){return}n=$(n);n.find(".title").each(function(){$(this).text(t.unescape($(this).text()))});n.attr("data-uuid",i);$(document.body).append(n);var a=$(n[0]);l.reposition(a);f.enhance(a,i,o);T(i);a.on("click",function(){if(!e.isActive(i)){e.updateActive(i)}});l.handleResize(a);if(f.bsEnvironment==="xs"||f.bsEnvironment==="sm"){var r=a.find(".composer-submit"),s=a.find(".mobile-navbar .composer-submit"),d=a.find(".write"),c=d.attr("tabindex");r.removeAttr("tabindex");s.attr("tabindex",parseInt(c,10)+1);$(".category-name-container").on("click",function(){$(".category-selector").toggleClass("open")})}$(window).trigger("action:composer.loaded",{post_uuid:i,composerData:f.posts[i],formatting:f.formatting});p.apply(a.find(".write"));_(a);E()})}function w(){var e="compose?p="+window.location.pathname,t=window.location.pathname.slice(1);if(t.startsWith(config.relative_path.slice(1))){t=t.slice(config.relative_path.length)}window.history.replaceState({url:null,returnPath:t},t,config.relative_path+"/"+t);window.history.pushState({url:e},e,config.relative_path+"/"+e)}function y(e){var t=e.find(".help");socket.emit("plugins.composer.renderHelp",function(e,i){if(!e&&i&&i.length>0){t.removeClass("hidden");t.on("click",function(){bootbox.alert(i)})}})}function x(e){var t=e.attr("data-uuid");var i=f.posts[t]&&f.posts[t].action==="posts.edit";var o=utils.findBootstrapEnvironment();var n=o==="xs"||o==="sm";if(i||n){return}var a=e.find("input.title");var r=e.find(".quick-search-results");a.on("blur",function(){setTimeout(function(){r.addClass("hidden")},200)});app.enableTopicSearch({inputEl:a,resultEl:r})}function T(e){if(f.active&&f.active!==e){f.minimize(f.active)}f.active=e}function _(e){setTimeout(function(){var t=e.find("input.title");if(t.length){t.focus()}else{e.find("textarea").focus().putCursorAtEnd()}},20)}function P(e){var t=f.posts[e];var i=$('.composer[data-uuid="'+e+'"]');var n=i.find(".handle");var d=i.find(".title");var l=i.find("textarea");var c=i.find("input#topic-thumb-url");var p=t.hasOwnProperty("template")&&t.template.compose===true;d.val(d.val().trim());l.val(utils.rtrim(l.val()));if(c.length){c.val(c.val().trim())}var m=t.action;var g=(t.hasOwnProperty("cid")||parseInt(t.pid,10))&&i.find("input.title").length;var v=!g||g&&parseInt(t.cid,10);if(o.inProgress[e]&&o.inProgress[e].length){return h(e,"[[error:still-uploading]]")}else if(g&&d.val().length<parseInt(config.minimumTitleLength,10)){return h(e,"[[error:title-too-short, "+config.minimumTitleLength+"]]")}else if(g&&d.val().length>parseInt(config.maximumTitleLength,10)){return h(e,"[[error:title-too-long, "+config.maximumTitleLength+"]]")}else if(m==="topics.post"&&!v){return h(e,"[[error:category-not-selected]]")}else if(g&&r.getTags(e)&&r.getTags(e).length<parseInt(config.minimumTagsPerTopic,10)){return h(e,"[[error:not-enough-tags, "+config.minimumTagsPerTopic+"]]")}else if(l.val().length<parseInt(config.minimumPostLength,10)){return h(e,"[[error:content-too-short, "+config.minimumPostLength+"]]")}else if(l.val().length>parseInt(config.maximumPostLength,10)){return h(e,"[[error:content-too-long, "+config.maximumPostLength+"]]")}var b={};if(m==="topics.post"){b={handle:n?n.val():undefined,title:d.val(),content:l.val(),thumb:c.val()||"",cid:s.getSelectedCid(),tags:r.getTags(e)}}else if(m==="posts.reply"){b={tid:t.tid,handle:n?n.val():undefined,content:l.val(),toPid:t.toPid}}else if(m==="posts.edit"){b={pid:t.pid,handle:n?n.val():undefined,content:l.val(),title:d.val(),thumb:c.val()||"",tags:r.getTags(e)}}$(window).trigger("action:composer.submit",{composerEl:i,action:m,composerData:b,postData:t});var w=$('#taskbar .composer[data-uuid="'+e+'"] i');var y=i.find(".write");w.removeClass("fa-plus").addClass("fa-circle-o-notch fa-spin");f.minimize(e);y.prop("readonly",true);socket.emit(m,b,function(o,n){i.find(".composer-submit").removeAttr("disabled");if(o){f.load(e);y.prop("readonly",false);if(o.message==="[[error:email-not-confirmed]]"){return app.showEmailConfirmWarning(o)}return app.alertError(o.message)}f.discard(e);a.removeDraft(t.save_id);if(n.queued){bootbox.alert(n.message)}else{if(m==="topics.post"){ajaxify.go("topic/"+n.slug,undefined,p||f.bsEnvironment==="xs"||f.bsEnvironment==="sm"?true:false)}else if(m==="posts.reply"){if(p||f.bsEnvironment==="xs"||f.bsEnvironment==="sm"){window.history.back()}else if(ajaxify.data.template.topic){if(parseInt(t.tid,10)!==parseInt(ajaxify.data.tid,10)){ajaxify.go("post/"+n.pid)}}else{ajaxify.go("post/"+n.pid)}}else{u()}}$(window).trigger("action:composer."+m,{composerData:b,data:n})})}function E(){$("html").addClass("composing")}function k(){$("body").css({paddingBottom:0});$("html").removeClass("composing");app.toggleNavbar(true)}f.discard=function(t){if(f.posts[t]){var i=$('.composer[data-uuid="'+t+'"]');i.remove();a.removeDraft(f.posts[t].save_id);delete f.posts[t];f.active=undefined;e.discard("composer",t);$('[data-action="post"]').removeAttr("disabled");$(window).trigger("action:composer.discard",{post_uuid:t})}k()};f.close=f.discard;f.minimize=function(t){var i=$('.composer[data-uuid="'+t+'"]');i.css("visibility","hidden");f.active=undefined;e.minimize("composer",t);$(window).trigger("action:composer.minimize",{post_uuid:t});k()};return f});
//# sourceMappingURL=composer.js.map