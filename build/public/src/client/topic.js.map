{"version":3,"sources":["public/src/client/topic.js"],"names":["define","infinitescroll","threadTools","postTools","events","posts","images","navigator","sort","components","storage","Topic","currentUrl","$","window","on","ev","data","replaceURLTimeout","clearTimeout","String","url","startsWith","disable","get","find","text","hide","app","removeAlert","removeListeners","require","search","topicDOM","active","end","init","tid","ajaxify","trigger","enterRoom","onTopicPageLoad","handleSort","slug","config","usePagination","loadMorePosts","addBlockQuoteHandler","addParentHandler","addDropupHandler","addRepliesHandler","postcount","toTop","toBottom","navigatorCallback","handleBookmark","updateTopicTitle","handleTopicSearch","off","prev","next","topicSearchEnabled","mousetrap","bind","e","match","currentPage","preventDefault","val","prepareSearch","scrollTop","socket","emit","err","postCount","alertError","message","scrollBottom","bookmark","getItem","postIndex","length","scrollToPostIndex","pagination","bookmarkThreshold","alert","alert_id","timeout","type","clickfn","scrollToIndex","parseInt","closefn","removeItem","setTimeout","blockQuote","this","parent","toggle","toggleClass","collapsed","hasClass","toPid","attr","toPost","target","dropUp","getBoundingClientRect","top","height","btn","replies","span","html","title","removeClass","addClass","index","elementCount","path","removeRelativePath","location","pathname","slice","scrollActive","newUrl","user","uid","updateUserBookmark","history","replaceState","test","protocol","host","RELATIVE_PATH","bookmarkKey","currentBookmark","topicPostSort","Math","max","setItem"],"mappings":"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","file":"public/src/client/topic.js","sourcesContent":["'use strict';\n\n\ndefine('forum/topic', [\n\t'forum/infinitescroll',\n\t'forum/topic/threadTools',\n\t'forum/topic/postTools',\n\t'forum/topic/events',\n\t'forum/topic/posts',\n\t'forum/topic/images',\n\t'navigator',\n\t'sort',\n\t'components',\n\t'storage',\n], function (infinitescroll, threadTools, postTools, events, posts, images, navigator, sort, components, storage) {\n\tvar\tTopic = {};\n\tvar currentUrl = '';\n\n\t$(window).on('action:ajaxify.start', function (ev, data) {\n\t\tif (Topic.replaceURLTimeout) {\n\t\t\tclearTimeout(Topic.replaceURLTimeout);\n\t\t\tTopic.replaceURLTimeout = 0;\n\t\t}\n\n\t\tif (!String(data.url).startsWith('topic/')) {\n\t\t\tnavigator.disable();\n\t\t\tcomponents.get('navbar/title').find('span').text('').hide();\n\t\t\tapp.removeAlert('bookmark');\n\n\t\t\tevents.removeListeners();\n\n\t\t\trequire(['search'], function (search) {\n\t\t\t\tif (search.topicDOM.active) {\n\t\t\t\t\tsearch.topicDOM.end();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n\n\tTopic.init = function () {\n\t\tvar tid = ajaxify.data.tid;\n\n\t\t$(window).trigger('action:topic.loading');\n\n\t\tapp.enterRoom('topic_' + tid);\n\n\t\tposts.onTopicPageLoad(components.get('post'));\n\n\t\tpostTools.init(tid);\n\t\tthreadTools.init(tid);\n\t\tevents.init();\n\n\t\tsort.handleSort('topicPostSort', 'user.setTopicSort', 'topic/' + ajaxify.data.slug);\n\n\t\tif (!config.usePagination) {\n\t\t\tinfinitescroll.init($('[component=\"topic\"]'), posts.loadMorePosts);\n\t\t}\n\n\t\taddBlockQuoteHandler();\n\t\taddParentHandler();\n\t\taddDropupHandler();\n\t\taddRepliesHandler();\n\n\t\tnavigator.init('[component=\"post\"]', ajaxify.data.postcount, Topic.toTop, Topic.toBottom, Topic.navigatorCallback);\n\n\t\thandleBookmark(tid);\n\n\t\t$(window).on('scroll', updateTopicTitle);\n\n\t\thandleTopicSearch();\n\n\t\t$(window).trigger('action:topic.loaded', ajaxify.data);\n\t};\n\n\tfunction handleTopicSearch() {\n\t\t$('.topic-search').off('click')\n\t\t\t.on('click', '.prev', function () {\n\t\t\t\trequire(['search'], function (search) {\n\t\t\t\t\tsearch.topicDOM.prev();\n\t\t\t\t});\n\t\t\t})\n\t\t\t.on('click', '.next', function () {\n\t\t\t\trequire(['search'], function (search) {\n\t\t\t\t\tsearch.topicDOM.next();\n\t\t\t\t});\n\t\t\t});\n\n\t\tif (config.topicSearchEnabled) {\n\t\t\trequire(['mousetrap'], function (mousetrap) {\n\t\t\t\tmousetrap.bind('ctrl+f', function (e) {\n\t\t\t\t\tvar match = ajaxify.currentPage.match(/^topic\\/([\\d]+)/);\n\t\t\t\t\tvar tid;\n\t\t\t\t\tif (match) {\n\t\t\t\t\t\te.preventDefault();\n\t\t\t\t\t\ttid = match[1];\n\t\t\t\t\t\t$('#search-fields input').val('in:topic-' + tid + ' ');\n\t\t\t\t\t\tapp.prepareSearch();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t}\n\n\tTopic.toTop = function () {\n\t\tnavigator.scrollTop(0);\n\t};\n\n\tTopic.toBottom = function () {\n\t\tsocket.emit('topics.postcount', ajaxify.data.tid, function (err, postCount) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\n\t\t\tnavigator.scrollBottom(postCount - 1);\n\t\t});\n\t};\n\n\tfunction handleBookmark(tid) {\n\t\t// use the user's bookmark data if available, fallback to local if available\n\t\tvar bookmark = ajaxify.data.bookmark || storage.getItem('topic:' + tid + ':bookmark');\n\t\tvar postIndex = ajaxify.data.postIndex;\n\n\t\tif (postIndex > 1) {\n\t\t\tif (components.get('post/anchor', postIndex - 1).length) {\n\t\t\t\treturn navigator.scrollToPostIndex(postIndex - 1, true, 0);\n\t\t\t}\n\t\t} else if (bookmark && (!config.usePagination || (config.usePagination && ajaxify.data.pagination.currentPage === 1)) && ajaxify.data.postcount > ajaxify.data.bookmarkThreshold) {\n\t\t\tapp.alert({\n\t\t\t\talert_id: 'bookmark',\n\t\t\t\tmessage: '[[topic:bookmark_instructions]]',\n\t\t\t\ttimeout: 0,\n\t\t\t\ttype: 'info',\n\t\t\t\tclickfn: function () {\n\t\t\t\t\tnavigator.scrollToIndex(parseInt(bookmark - 1, 10), true);\n\t\t\t\t},\n\t\t\t\tclosefn: function () {\n\t\t\t\t\tstorage.removeItem('topic:' + tid + ':bookmark');\n\t\t\t\t},\n\t\t\t});\n\t\t\tsetTimeout(function () {\n\t\t\t\tapp.removeAlert('bookmark');\n\t\t\t}, 10000);\n\t\t}\n\t}\n\n\tfunction addBlockQuoteHandler() {\n\t\tcomponents.get('topic').on('click', 'blockquote .toggle', function () {\n\t\t\tvar blockQuote = $(this).parent('blockquote');\n\t\t\tvar toggle = $(this);\n\t\t\tblockQuote.toggleClass('uncollapsed');\n\t\t\tvar collapsed = !blockQuote.hasClass('uncollapsed');\n\t\t\ttoggle.toggleClass('fa-angle-down', collapsed).toggleClass('fa-angle-up', !collapsed);\n\t\t});\n\t}\n\n\tfunction addParentHandler() {\n\t\tcomponents.get('topic').on('click', '[component=\"post/parent\"]', function (e) {\n\t\t\tvar toPid = $(this).attr('data-topid');\n\n\t\t\tvar toPost = $('[component=\"topic\"]>[component=\"post\"][data-pid=\"' + toPid + '\"]');\n\t\t\tif (toPost.length) {\n\t\t\t\te.preventDefault();\n\t\t\t\tnavigator.scrollToIndex(toPost.attr('data-index'), true);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction addDropupHandler() {\n\t\t// Locate all dropdowns\n\t\tvar target = $('#content .dropdown-menu').parent();\n\n\t\t// Toggle dropup if past 50% of screen\n\t\t$(target).on('show.bs.dropdown', function () {\n\t\t\tvar dropUp = this.getBoundingClientRect().top > ($(window).height() / 2);\n\t\t\t$(this).toggleClass('dropup', dropUp);\n\t\t});\n\t}\n\n\tfunction addRepliesHandler() {\n\t\t$('[component=\"topic\"]').on('click', '[component=\"post/reply-count\"]', function () {\n\t\t\tvar btn = $(this);\n\t\t\trequire(['forum/topic/replies'], function (replies) {\n\t\t\t\treplies.init(btn);\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction updateTopicTitle() {\n\t\tvar span = components.get('navbar/title').find('span');\n\t\tif ($(window).scrollTop() > 50 && span.hasClass('hidden')) {\n\t\t\tspan.html(ajaxify.data.title).removeClass('hidden');\n\t\t} else if ($(window).scrollTop() <= 50 && !span.hasClass('hidden')) {\n\t\t\tspan.html('').addClass('hidden');\n\t\t}\n\t\tif ($(window).scrollTop() > 300) {\n\t\t\tapp.removeAlert('bookmark');\n\t\t}\n\t}\n\n\tTopic.navigatorCallback = function (index, elementCount) {\n\t\tvar path = ajaxify.removeRelativePath(window.location.pathname.slice(1));\n\t\tif (!path.startsWith('topic')) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (navigator.scrollActive) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar newUrl = 'topic/' + ajaxify.data.slug + (index > 1 ? ('/' + index) : '');\n\n\t\tif (newUrl !== currentUrl) {\n\t\t\tif (Topic.replaceURLTimeout) {\n\t\t\t\tclearTimeout(Topic.replaceURLTimeout);\n\t\t\t}\n\n\t\t\tTopic.replaceURLTimeout = setTimeout(function () {\n\t\t\t\tif (index >= elementCount && app.user.uid) {\n\t\t\t\t\tsocket.emit('topics.markAsRead', [ajaxify.data.tid]);\n\t\t\t\t}\n\n\t\t\t\tupdateUserBookmark(index);\n\n\t\t\t\tTopic.replaceURLTimeout = 0;\n\t\t\t\tif (history.replaceState) {\n\t\t\t\t\tvar search = window.location.search || '';\n\t\t\t\t\tif (!config.usePagination) {\n\t\t\t\t\t\tsearch = (search && !/^\\?page=\\d+$/.test(search) ? search : '');\n\t\t\t\t\t}\n\n\t\t\t\t\thistory.replaceState({\n\t\t\t\t\t\turl: newUrl + search,\n\t\t\t\t\t}, null, window.location.protocol + '//' + window.location.host + RELATIVE_PATH + '/' + newUrl + search);\n\t\t\t\t}\n\t\t\t\tcurrentUrl = newUrl;\n\t\t\t}, 500);\n\t\t}\n\t};\n\n\tfunction updateUserBookmark(index) {\n\t\tvar bookmarkKey = 'topic:' + ajaxify.data.tid + ':bookmark';\n\t\tvar currentBookmark = ajaxify.data.bookmark || storage.getItem(bookmarkKey);\n\t\tif (config.topicPostSort === 'newest_to_oldest') {\n\t\t\tindex = Math.max(1, ajaxify.data.postcount - index + 2);\n\t\t}\n\n\t\tif (ajaxify.data.postcount > ajaxify.data.bookmarkThreshold && (!currentBookmark || parseInt(index, 10) > parseInt(currentBookmark, 10) || ajaxify.data.postcount < parseInt(currentBookmark, 10))) {\n\t\t\tif (app.user.uid) {\n\t\t\t\tsocket.emit('topics.bookmark', {\n\t\t\t\t\ttid: ajaxify.data.tid,\n\t\t\t\t\tindex: index,\n\t\t\t\t}, function (err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t}\n\t\t\t\t\tajaxify.data.bookmark = index;\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tstorage.setItem(bookmarkKey, index);\n\t\t\t}\n\t\t}\n\n\t\t// removes the bookmark alert when we get to / past the bookmark\n\t\tif (!currentBookmark || parseInt(index, 10) >= parseInt(currentBookmark, 10)) {\n\t\t\tapp.removeAlert('bookmark');\n\t\t}\n\t}\n\n\n\treturn Topic;\n});\n"]}